YUI.add("moodle-quizaccess_offlinemode-download",function(n,e){M.quizaccess_offlinemode=M.quizaccess_offlinemode||{},M.quizaccess_offlinemode.download={SELECTORS:{DOWNLOAD_CONFIRM_MESSAGE:"#quiz-download-confirm-message",QUIZ_FORM:"#responseform"},filename:null,publicKey:null,form:null,init:function(e,t){this.filename=e,this.publicKey=t,n.Crypto.sjcl.random.startCollectors(),n.Crypto.sjcl.beware["CBC mode is dangerous because it doesn't protect message integrity."](),this.form=n.one(this.SELECTORS.QUIZ_FORM),this.form&&n.delegate("click",this.downloadClicked,"body",".response-download-link",this)},downloadClicked:function(e){var t,e=e.currentTarget;"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),e.set("download",this.filename.replace(/-d\d+\.attemptdata/,"-d"+this.getCurrentDatestamp()+".attemptdata")),t={responses:n.IO.stringify(this.form)},this.publicKey&&(t=this.encryptResponses(t)),e.set("href","data:application/octet-stream,"+n.JSON.stringify(t)),n.later(500,this,this.showDownloadMessage,e.ancestor("p").ancestor())},getCurrentDatestamp:function(){var e=new Date;function t(e){return e<10?"0"+e:e}return""+e.getUTCFullYear()+t(e.getUTCMonth()+1)+t(e.getUTCDate())+t(e.getUTCHours())+t(e.getUTCMinutes())},showDownloadMessage:function(e){function t(e){return e<10?"0"+e:e}n.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE)&&n.one(this.SELECTORS.DOWNLOAD_CONFIRM_MESSAGE).remove(!0),now=new Date,e.append('<p id="quiz-download-confirm-message">'+M.util.get_string("lastsavedtothiscomputer","quizaccess_offlinemode",t(now.getHours())+":"+t(now.getMinutes()))+"</p>")},encryptResponses:function(e){var t=n.Crypto.sjcl.random.randomWords(8),o={},e=n.Crypto.sjcl.encrypt(t,e.responses,{ks:256,mode:"cbc"},o),s=new n.Crypto.JSEncrypt;return s.setPublicKey(this.publicKey),{responses:n.JSON.parse(e).ct,key:s.encrypt(n.Crypto.sjcl.codec.base64.fromBits(t)),iv:s.encrypt(n.Crypto.sjcl.codec.base64.fromBits(o.iv))}}}},"@VERSION@",{requires:["base","node","event","node-event-delegate","json","io-form","moodle-quizaccess_offlinemode-jsencrypt","moodle-quizaccess_offlinemode-sjcl"]});
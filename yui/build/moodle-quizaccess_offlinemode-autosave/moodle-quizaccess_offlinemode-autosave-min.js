YUI.add("moodle-quizaccess_offlinemode-autosave",function(n,e){M.quizaccess_offlinemode=M.quizaccess_offlinemode||{},M.quizaccess_offlinemode.autosave={TINYMCE_DETECTION_DELAY:500,TINYMCE_DETECTION_REPEATS:20,WATCH_HIDDEN_DELAY:1e3,SAVE_TIMEOUT:3e4,SELECTORS:{QUIZ_FORM:"#responseform",VALUE_CHANGE_ELEMENTS:'input, textarea, [contenteditable="true"]',CHANGE_ELEMENTS:"input, select",HIDDEN_INPUTS:"input[type=hidden]",NAV_BUTTON:"#quiznavbutton",QUESTION_CONTAINER:"#q",STATE_HOLDER:" .state",SUMMARY_ROW:".quizsummaryofattempt tr.quizsummary",STATE_COLUMN:" .c1",FINISH_ATTEMPT_INPUT:"input[name=finishattempt]",SUBMIT_BUTTON:"[type=submit]",FORM:"form",SAVING_NOTICE:"#quiz-saving",LAST_SAVED_MESSAGE:"#quiz-last-saved-message",LAST_SAVED_TIME:"#quiz-last-saved",SAVE_FAILED_NOTICE:"#mod_quiz_navblock .quiz-save-failed"},AUTOSAVE_HANDLER:M.cfg.wwwroot+"/mod/quiz/accessrule/offlinemode/autosave.ajax.php",RELOGIN_SCRIPT:M.cfg.wwwroot+"/mod/quiz/accessrule/offlinemode/relogin.php",delay:12e4,form:null,dirty:!1,delay_timer:null,save_transaction:null,last_successful_save:null,editor_change_handler:null,hidden_field_values:{},init:function(e,t){this.SELECTORS.QUESTION_CONTAINER=t,this.form=n.one(this.SELECTORS.QUIZ_FORM),this.form&&(M.core_question_engine.init_form(n,this.SELECTORS.QUIZ_FORM),n.on("submit",M.mod_quiz.timer.stop,this.SELECTORS.QUIZ_FORM),window.onbeforeunload=n.bind(this.warn_if_unsaved_data,this),this.delay=1e3*e,this.form.delegate("valuechange",this.value_changed,this.SELECTORS.VALUE_CHANGE_ELEMENTS,this),this.form.delegate("change",this.value_changed,this.SELECTORS.CHANGE_ELEMENTS,this),(t=n.one(this.SELECTORS.FINISH_ATTEMPT_INPUT).siblings(this.SELECTORS.SUBMIT_BUTTON).pop()).detach("click"),t.on("click",this.submit_and_finish_clicked,this),this.create_status_messages(),this.init_tinymce(this.TINYMCE_DETECTION_REPEATS),this.save_hidden_field_values(),this.watch_hidden_fields())},save_hidden_field_values:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(e){var t=e.get("name");t&&(this.hidden_field_values[t]=e.get("value"))},this)},watch_hidden_fields:function(){this.detect_hidden_field_changes(),n.later(this.WATCH_HIDDEN_DELAY,this,this.watch_hidden_fields)},detect_hidden_field_changes:function(){this.form.all(this.SELECTORS.HIDDEN_INPUTS).each(function(e){var t=e.get("name"),i=e.get("value");t&&"sesskey"!==t&&(t in this.hidden_field_values&&i===this.hidden_field_values[t]||(this.hidden_field_values[t]=i,this.value_changed({target:e})))},this)},init_tinymce:function(e){"undefined"!=typeof tinyMCE?(this.editor_change_handler=n.bind(this.editor_changed,this),tinyMCE.onAddEditor.add(n.bind(this.init_tinymce_editor,this))):0<e&&n.later(this.TINYMCE_DETECTION_DELAY,this,this.init_tinymce,[e-1])},init_tinymce_editor:function(e,t){t.onChange.add(this.editor_change_handler),t.onRedo.add(this.editor_change_handler),t.onUndo.add(this.editor_change_handler),t.onKeyDown.add(this.editor_change_handler)},value_changed:function(e){var t=e.target.getAttribute("name");"thispage"===t||"scrollpos"===t||t&&t.match(/_:flagged$/)||(t=t||"#"+e.target.getAttribute("id"),this.start_save_timer_if_necessary(),this.mark_question_changed_if_necessary(t))},editor_changed:function(e){this.start_save_timer_if_necessary(),this.mark_question_changed_if_necessary(e.id)},mark_question_changed_if_necessary:function(e){e=this.get_slot_from_id(e);e&&(this.set_question_state_string(e,M.util.get_string("answerchanged","quizaccess_offlinemode")),this.set_question_state_class(e,"answersaved"))},get_slot_from_id:function(e){e=e.match(/^#?q\d+:(\d+)_.*$/);return e?e[1]:undefined},set_question_state_string:function(e,t){n.one(this.SELECTORS.QUESTION_CONTAINER+e+this.SELECTORS.STATE_HOLDER).setHTML(n.Escape.html(t));var i=n.one(this.SELECTORS.SUMMARY_ROW+e+this.SELECTORS.STATE_COLUMN);i&&i.setHTML(n.Escape.html(t)),n.one(this.SELECTORS.NAV_BUTTON+e).set("title",n.Escape.html(t))},update_question_state_strings:function(e){n.Object.each(e,function(e,t){this.set_question_state_string(t,e)},this)},set_question_state_class:function(e,t){e=n.one(this.SELECTORS.NAV_BUTTON+e);e.set("className",e.get("className").replace(/^qnbutton \w+\b/,"qnbutton "+n.Escape.html(t)))},update_question_state_classes:function(e){n.Object.each(e,function(e,t){this.set_question_state_class(t,e)},this)},start_save_timer_if_necessary:function(){this.dirty=!0,this.delay_timer||this.save_transaction||this.start_save_timer()},start_save_timer:function(){this.cancel_delay(),this.delay_timer=n.later(this.delay,this,this.save_changes)},cancel_delay:function(){this.delay_timer&&!0!==this.delay_timer&&this.delay_timer.cancel(),this.delay_timer=null},save_changes:function(){this.cancel_delay(),this.dirty=!1,this.is_time_nearly_over()?this.stop_autosaving():("undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),this.save_transaction=n.io(this.AUTOSAVE_HANDLER,{method:"POST",form:{id:this.form},on:{success:this.save_done,failure:this.save_failed},context:this,timeout:this.SAVE_TIMEOUT}),n.one(this.SELECTORS.SAVING_NOTICE).setStyle("visibility","visible"))},save_done:function(e,t){var i;try{i=n.JSON.parse(t.responseText)}catch(s){return void this.save_failed(e,t)}if("lostsession"===i.result)return this.save_transaction=null,this.dirty=!0,void this.try_to_restore_session();"OK"===i.result?(this.save_transaction=null,this.update_status_for_successful_save(),this.update_question_state_classes(i.questionstates),this.update_question_state_strings(i.questionstatestrs),this.dirty&&this.start_save_timer()):this.save_failed(e,t)},save_failed:function(){this.save_transaction=null,this.update_status_for_failed_save(),this.dirty=!0,this.start_save_timer()},is_time_nearly_over:function(){return M.mod_quiz.timer&&M.mod_quiz.timer.endtime&&(new Date).getTime()+2*this.delay>M.mod_quiz.timer.endtime},stop_autosaving:function(){this.cancel_delay(),this.delay_timer=!0,this.save_transaction&&this.save_transaction.abort()},warn_if_unsaved_data:function(e){if(
this.dirty||this.save_transaction)return e.returnValue=M.util.get_string("changesmadereallygoaway","quizaccess_offlinemode"),e.returnValue},submit_and_finish_clicked:function(e){e.halt(!0);e=new M.core.confirm({id:"submit-confirmation",width:"300px",center:!0,modal:!0,visible:!1,draggable:!1,title:M.util.get_string("confirmation","admin"),noLabel:M.util.get_string("cancel","moodle"),yesLabel:M.util.get_string("submitallandfinish","quiz"),question:M.util.get_string("confirmclose","quiz")});e.on("complete-yes",this.submit_and_finish,this),e.render().show()},submit_and_finish:function(e){var t;e.halt(),this.stop_autosaving(),e=n.one(this.SELECTORS.FINISH_ATTEMPT_INPUT).siblings(this.SELECTORS.SUBMIT_BUTTON).pop(),this.get_submit_progress(e.ancestor(".controls")).show(),e.ancestor(".singlebutton").hide(),t=this.get_submit_failed_message(e.ancestor(".controls")),e.ancestor(".controls").removeClass("quiz-save-failed"),t.header.hide(),t.message.hide(),this.form.append('<input name="finishattempt" value="1">'),"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),this.save_transaction=n.io(this.AUTOSAVE_HANDLER,{method:"POST",form:{id:this.form},on:{success:this.submit_done,failure:this.submit_failed},context:this,timeout:this.SAVE_TIMEOUT})},submit_done:function(e,t){var i;try{i=n.JSON.parse(t.responseText)}catch(s){return void this.submit_failed(e,t)}"OK"===i.result?(this.save_transaction=null,this.dirty=!1,window.location.replace(i.reviewurl)):this.submit_failed(e,t)},submit_failed:function(){var e,t;this.save_transaction=null,this.form.one(this.SELECTORS.FINISH_ATTEMPT_INPUT).remove(),e=n.one(this.SELECTORS.FINISH_ATTEMPT_INPUT).siblings(this.SELECTORS.SUBMIT_BUTTON).pop(),t=this.get_submit_progress(e.ancestor(".controls")),e.ancestor(".singlebutton").show(),t.hide(),t=this.get_submit_failed_message(e.ancestor(".controls")),e.ancestor(".controls").addClass("quiz-save-failed"),t.header.show(),t.message.show(),this.update_status_for_failed_save()},get_submit_progress:function(e){var t=e.one(".submit-progress");return t||(t=e.appendChild('<div class="submit-progress">'),M.util.add_spinner(n,t).show(),t.append(M.util.get_string("submitting","quizaccess_offlinemode")),t)},get_submit_failed_message:function(e){var t,i=e.one(".submit-failed-header");return i?{header:i,message:e.one(".submit-failed-message")}:(e.insert('<div class="submit-failed-header">',0),(i=e.one(".submit-failed-header")).append("<h4>"+M.util.get_string("submitfailed","quizaccess_offlinemode")+"</h4>"),i.append("<p>"+M.util.get_string("submitfailedmessage","quizaccess_offlinemode")+"</p>"),t='<a href="#" class="response-download-link">'+M.util.get_string("savetheresponses","quizaccess_offlinemode")+"</a>",(e=e.appendChild('<div class="submit-failed-message">')).append("<p>"+M.util.get_string("submitfaileddownloadmessage","quizaccess_offlinemode",t)+"</p>"),{header:i,message:e})},create_status_messages:function(){var e='<a href="#" class="response-download-link">'+M.util.get_string("savetheresponses","quizaccess_offlinemode")+"</a>";n.one("#mod_quiz_navblock .content").append('<div id="quiz-save-status"><div id="quiz-last-saved-message">'+M.util.get_string("lastsaved","quizaccess_offlinemode",'<span id="quiz-last-saved"></span>')+'</div><div id="quiz-saving">'+M.util.get_string("savingdots","quizaccess_offlinemode")+'</div><div class="quiz-save-failed">'+M.util.get_string("savefailed","quizaccess_offlinemode",e)+"</div></div>"),this.update_status_for_successful_save()},update_status_for_successful_save:function(){function e(e){return e<10?"0"+e:e}this.last_successful_save=new Date,n.one(this.SELECTORS.LAST_SAVED_TIME).setHTML(e(this.last_successful_save.getHours())+":"+e(this.last_successful_save.getMinutes())),n.one(this.SELECTORS.SAVING_NOTICE).setStyle("visibility","hidden"),n.one(this.SELECTORS.SAVING_NOTICE).setHTML(M.util.get_string("savingdots","quizaccess_offlinemode")),n.one(this.SELECTORS.SAVE_FAILED_NOTICE).hide()},update_status_for_failed_save:function(){n.one(this.SELECTORS.LAST_SAVED_MESSAGE).setHTML(M.util.get_string("lastsavedtotheserver","quizaccess_offlinemode",n.one(this.SELECTORS.LAST_SAVED_TIME).get("outerHTML"))),n.one(this.SELECTORS.SAVING_NOTICE).setStyle("visibility","hidden"),n.one(this.SELECTORS.SAVING_NOTICE).setHTML(M.util.get_string("savingtryagaindots","quizaccess_offlinemode")),n.one(this.SELECTORS.SAVE_FAILED_NOTICE).show()},try_to_restore_session:function(){this.loginDialogue=new M.core.notification.info({id:"quiz-relogin-dialogue",width:"70%",center:!0,modal:!0,visible:!1,draggable:!1}),this.loginDialogue.setStdModContent(n.WidgetStdMod.HEADER,'<h1 id="moodle-quiz-relogin-dialogue-header-text">'+M.util.get_string("logindialogueheader","quizaccess_offlinemode")+"</h1>",n.WidgetStdMod.REPLACE),this.loginDialogue.setStdModContent(n.WidgetStdMod.BODY,'<iframe src="'+this.RELOGIN_SCRIPT+"?userid="+n.one("#quiz-userid").get("value")+'">',n.WidgetStdMod.REPLACE),this.loginDialogue.render().show()},restore_session_complete:function(e){n.all("input[name=sesskey]").set("value",e),this.loginDialogue&&(this.loginDialogue.hide().destroy(),this.loginDialogue=null),this.save_changes()}}},"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form","core_question_engine","mod_quiz"]});